<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PYXIS - 관리자</title>
<script src="/socket.io/socket.io.js"></script>
<style>
:root{
  --bg:#0a0a0a; --bg2:#0e0e0e;
  --surface:#121212; --panel:#171717;
  --gold:#DCC7A2; --gold2:#E6D2A8; --gold3:#C9A86A;
  --text:#F5F6F7; --muted:#A3A8B0; --accent:#C9A86A;
  --danger:#E74C3C; --ok:#49B165;
  --field:#1a1a1a; --field-border:rgba(220,199,162,.25);
  --radius:14px; --shadow:0 10px 30px rgba(0,0,0,.35);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;color:var(--text);
  background:linear-gradient(180deg,var(--bg),var(--bg2));
  font-family:ui-sans-serif,system-ui,"Apple SD Gothic Neo","Malgun Gothic","Noto Sans KR",sans-serif
}

/* ====== GRID (2행 3열) ====== */
.wrap{
  max-width:1480px;margin:0 auto;padding:28px 18px;
  display:grid;gap:18px;
  grid-template-columns:repeat(3,1fr);
  grid-template-rows:auto auto;
  grid-template-areas:
    "ctrl form logs"
    "spect team chat";
}
@media(max-width:1200px){
  .wrap{grid-template-columns:1fr;grid-template-areas:
    "ctrl" "form" "logs" "spect" "team" "chat";}
}

/* ====== CARDS ====== */
.card{
  background:linear-gradient(180deg,rgba(255,255,255,.035),rgba(255,255,255,.02)),var(--surface);
  border:1px solid var(--field-border);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  min-height:260px;
  padding:18px 18px 14px;
}
.card h3{
  margin:0 0 14px 0;font-weight:700;letter-spacing:.2px;
  color:var(--gold2)
}
.small{font-size:12px;color:var(--muted)}

/* areas */
#cardCtrl{grid-area:ctrl}
#cardForm{grid-area:form}
#cardLogs{grid-area:logs}
#cardSpect{grid-area:spect}
#cardTeam{grid-area:team}
#cardChat{grid-area:chat}

/* ====== FIELDS (다크) ====== */
label{display:block;margin:8px 0 6px 2px;color:var(--gold)}
input[type="text"],input[type="number"],input[type="url"],input[type="file"],
select,textarea{
  width:100%;background:var(--field);color:var(--text);
  border:1px solid var(--field-border);border-radius:10px;
  padding:10px 12px;outline:none;appearance:none;
}
textarea{min-height:90px;resize:vertical}
input::placeholder,textarea::placeholder{color:#8f8f8f}
input:focus,select:focus,textarea:focus{
  border-color:var(--gold3);box-shadow:0 0 0 3px rgba(201,168,106,.18)
}

/* ====== BUTTONS ====== */
.btn{
  background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02)),var(--panel);
  border:1px solid var(--field-border); color:var(--text);
  padding:10px 14px;border-radius:12px;cursor:pointer;user-select:none;
}
.btn:hover{border-color:var(--gold3)}
.btn.gold{background:linear-gradient(180deg,rgba(220,199,162,.16),rgba(220,199,162,.06));color:#1a1a1a;border-color:var(--gold3)}
.btn.danger{border-color:#d16457;color:#ffd7d2;background:linear-gradient(180deg,rgba(215,93,77,.15),rgba(215,93,77,.07))}
.btn:disabled{opacity:.5;cursor:not-allowed}

/* ====== STACKS ====== */
.row{display:flex;gap:10px;flex-wrap:wrap}
.row .btn{flex:0 0 auto}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}

/* ====== LOGS/CHAT ====== */
.scroll{
  height:360px;overflow:auto;background:var(--panel);
  border:1px solid var(--field-border);border-radius:10px;padding:10px
}
.log.system{color:#D1BFA0}
.log.combat{color:#F2E2C9}
.log.heal{color:#A7E3B1}
.log.error{color:#FF9A8A}

/* ====== TEAM TABLE ====== */
.table{width:100%;border-collapse:collapse}
.table th,.table td{
  border-bottom:1px solid rgba(220,199,162,.15);
  padding:8px 10px;text-align:left;font-size:14px
}
.table th{color:var(--gold2);font-weight:700}
.badge{display:inline-block;padding:2px 8px;border:1px solid var(--field-border);border-radius:999px;color:var(--gold2);font-size:12px}

/* other */
.kv{display:flex;align-items:center;gap:10px}
.kv .key{color:var(--muted);min-width:90px}
.preview{
  width:96px;height:96px;border-radius:12px;border:1px solid var(--field-border);
  background:#0f0f0f;object-fit:cover
}
.meta{display:flex;align-items:center;gap:8px}
.dot{width:10px;height:10px;border-radius:50%;background:#888;display:inline-block}
.dot.ok{background:var(--ok)} .dot.bad{background:#b04a4a}

.copy{font-size:12px;color:var(--muted);word-break:break-all}
</style>
</head>
<body>

<div class="wrap">

  <!-- 전투 제어 -->
  <section id="cardCtrl" class="card">
    <h3>전투 제어</h3>
    <div class="meta" style="justify-content:space-between;margin-bottom:10px">
      <div class="kv"><span class="key">연결</span><span id="connDot" class="dot"></span><span id="connText" class="small">연결 대기</span></div>
      <div class="kv"><span class="key">모드</span>
        <select id="mode" style="min-width:120px">
          <option>1v1</option><option>2v2</option><option selected>2v2</option><option>3v3</option><option>4v4</option>
        </select>
      </div>
    </div>
    <div class="row" style="margin-bottom:8px">
      <button id="btnCreate" class="btn gold">전투 생성</button>
      <button id="btnStart"  class="btn">시작</button>
      <button id="btnPause"  class="btn">일시정지</button>
      <button id="btnResume" class="btn">재개</button>
      <button id="btnEnd"    class="btn danger">종료</button>
    </div>
    <div class="small">현재 배틀: <span id="currentBattleId">없음</span></div>
  </section>

  <!-- 참가자 입력 -->
  <section id="cardForm" class="card">
    <h3>참가자 입력</h3>
    <div class="grid2">
      <div>
        <label for="pName">이름</label>
        <input id="pName" type="text" placeholder="이름을 입력하세요"/>
      </div>
      <div class="grid2">
        <div>
          <label for="pTeam">팀</label>
          <select id="pTeam"><option value="A">A팀</option><option value="B">B팀</option></select>
        </div>
        <div>
          <label for="pHp">HP</label>
          <input id="pHp" type="number" min="1" max="100" value="100"/>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:10px;align-items:flex-end">
      <div>
        <label for="pAvatar">이미지</label>
        <input id="pAvatar" type="file" accept="image/*"/>
      </div>
      <img id="preview" class="preview" alt="미리보기"/>
    </div>

    <div style="margin-top:12px">
      <div class="grid4">
        <div><label for="sAtk">공(1~5)</label><input id="sAtk" type="number" min="1" max="5" value="3"/></div>
        <div><label for="sDef">방(1~5)</label><input id="sDef" type="number" min="1" max="5" value="3"/></div>
        <div><label for="sAgi">민(1~5)</label><input id="sAgi" type="number" min="1" max="5" value="3"/></div>
        <div><label for="sLuk">행(1~5)</label><input id="sLuk" type="number" min="1" max="5" value="2"/></div>
      </div>
    </div>

    <div class="grid3" style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px">
      <div><label for="iDit">디터니</label><input id="iDit" type="number" min="0" value="0"/></div>
      <div><label for="iAtkB">공보</label><input id="iAtkB" type="number" min="0" value="0"/></div>
      <div><label for="iDefB">방보</label><input id="iDefB" type="number" min="0" value="0"/></div>
    </div>

    <div class="row" style="margin-top:12px"><button id="btnAdd" class="btn gold">전투 참가자 추가</button></div>
  </section>

  <!-- 실시간 로그 -->
  <section id="cardLogs" class="card">
    <h3>실시간 로그</h3>
    <div id="logs" class="scroll" aria-live="polite"></div>
  </section>

  <!-- 관전자/링크 -->
  <section id="cardSpect" class="card">
    <h3>관전자 · 링크</h3>
    <div class="grid2">
      <div>
        <div class="row"><button id="btnGenSpectator" class="btn">비밀번호 발급</button></div>
        <label for="spectatorOtp">관전자 비밀번호</label>
        <input id="spectatorOtp" type="text" readonly/>
      </div>
      <div>
        <div class="row"><button id="btnBuildSpectator" class="btn">URL 생성/복사</button></div>
        <label for="spectatorUrl">관전자 URL</label>
        <input id="spectatorUrl" type="url" readonly/>
        <div class="copy small">※ URL은 배틀ID & OTP 포함</div>
      </div>
    </div>

    <div style="margin-top:14px">
      <h4 style="margin:0 0 8px 0;color:var(--gold2)">참가자 개별 링크</h4>
      <div id="playerLinks" class="small" style="display:grid;gap:8px"></div>
    </div>
  </section>

  <!-- 팀 구성 -->
  <section id="cardTeam" class="card">
    <h3>팀 구성</h3>
    <div class="grid2">
      <div>
        <div class="meta" style="justify-content:space-between;margin-bottom:6px">
          <span class="badge">A팀</span>
        </div>
        <table class="table">
          <thead><tr><th>이름</th><th>HP</th><th>스탯(공/방/민/행)</th><th>아이템(디/공/방)</th><th>상태</th><th>삭제</th></tr></thead>
          <tbody id="listA"></tbody>
        </table>
      </div>
      <div>
        <div class="meta" style="justify-content:space-between;margin-bottom:6px">
          <span class="badge">B팀</span>
        </div>
        <table class="table">
          <thead><tr><th>이름</th><th>HP</th><th>스탯(공/방/민/행)</th><th>아이템(디/공/방)</th><th>상태</th><th>삭제</th></tr></thead>
          <tbody id="listB"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- 채팅 -->
  <section id="cardChat" class="card">
    <h3>채팅</h3>
    <div id="chatLogs" class="scroll"></div>
    <div class="row" style="margin-top:10px">
      <input id="chatMsg" type="text" placeholder="메시지 입력" style="flex:1"/>
      <button id="btnSend" class="btn gold">전송</button>
    </div>
  </section>

</div>

<script>
/* ===== helpers ===== */
const $ = (id)=>document.getElementById(id);
const qs = (sel,root=document)=>root.querySelector(sel);
const current = { battleId: new URL(location.href).searchParams.get('battle')||'' };
const socket = io('/', { path:'/socket.io' });

function setConn(ok){ $('connDot').className = 'dot ' + (ok?'ok':'bad'); $('connText').textContent = ok?'연결됨':'연결 끊김'; }
socket.on('connect',()=>setConn(true));
socket.on('disconnect',()=>setConn(false));

function setBattleId(id){
  current.battleId = id;
  $('currentBattleId').textContent = id || '없음';
  const u = new URL(location.href); if(id){ u.searchParams.set('battle', id); history.replaceState({},'',u); }
}

function addLog(entry){
  const box=$('logs'); if(!entry) return;
  const t=new Date().toLocaleTimeString('ko-KR',{hour12:false});
  const div=document.createElement('div'); div.className='log '+(entry.type||'system');
  div.textContent = `[${t}] ${entry.message||''}`;
  box.appendChild(div); box.scrollTop=box.scrollHeight;
}

const chatSeen = new Set(); // 중복 방지
function addChat({name,message}){
  const key = (name||'') + '|' + (message||'');
  if(chatSeen.has(key)) return;
  chatSeen.add(key); setTimeout(()=>chatSeen.delete(key),1000);
  const t=new Date().toLocaleTimeString('ko-KR',{hour12:false});
  const el=document.createElement('div'); el.className='log system';
  el.textContent=`[${t}] ${name||'익명'}: ${message||''}`;
  $('chatLogs').appendChild(el); $('chatLogs').scrollTop=$('chatLogs').scrollHeight;
}

function renderTeams(b){
  const A=$('listA'), B=$('listB'); A.innerHTML=''; B.innerHTML='';
  (b.players||[]).forEach(p=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${p.name||''}</td>
      <td>${p.hp}/${p.maxHp||100}</td>
      <td>${p.stats?.attack||0}/${p.stats?.defense||0}/${p.stats?.agility||0}/${p.stats?.luck||0}</td>
      <td>${p.items?.dittany||0}/${p.items?.attack_boost||0}/${p.items?.defense_boost||0}</td>
      <td>${p.ready?'준비':'대기'}</td>
      <td><button class="btn danger" data-id="${p.id}">삭제</button></td>`;
    (p.team==='A'?A:B).appendChild(tr);
    tr.querySelector('button').onclick=()=> {
      if(!current.battleId) return;
      socket.emit('removePlayer',{battleId:current.battleId,playerId:p.id});
    };
  });
}

/* ===== wire ===== */
$('btnCreate').onclick = ()=>{
  socket.emit('createBattle',{mode:$('mode').value},(res)=>{ if(res?.ok){ setBattleId(res.battleId); }});
};
socket.on('battleCreated', (d)=>{ if(d?.battleId) setBattleId(d.battleId); });
socket.on('battle:created', (d)=>{ if(d?.battleId) setBattleId(d.battleId); });

$('btnStart').onclick = ()=> current.battleId && socket.emit('startBattle',{battleId:current.battleId});
$('btnPause').onclick = ()=> current.battleId && socket.emit('pauseBattle',{battleId:current.battleId});
$('btnResume').onclick= ()=> current.battleId && socket.emit('resumeBattle',{battleId:current.battleId});
$('btnEnd').onclick   = ()=> current.battleId && socket.emit('endBattle',{battleId:current.battleId});

$('pAvatar').addEventListener('change', (e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  $('preview').src = URL.createObjectURL(f);
});

$('btnAdd').onclick = async ()=>{
  if(!current.battleId) return alert('전투를 먼저 생성하세요.');
  // 이미지 업로드(선택)
  let avatar='';
  const file=$('pAvatar').files?.[0];
  if(file){
    const fd=new FormData(); fd.append('avatar', file);
    const res=await fetch('/api/upload/avatar',{method:'POST',body:fd}).then(r=>r.json()).catch(()=>({ok:false}));
    if(res?.ok) avatar = res.url;
  }
  const player={
    name:$('pName').value||'이름',
    team:$('pTeam').value==='B'?'B':'A',
    hp:Number($('pHp').value||100),
    avatar,
    stats:{ attack:+$('sAtk').value, defense:+$('sDef').value, agility:+$('sAgi').value, luck:+$('sLuk').value },
    items:{ dittany:+$('iDit').value, attack_boost:+$('iAtkB').value, defense_boost:+$('iDefB').value }
  };
  socket.emit('addPlayer',{battleId:current.battleId, player});
};

$('btnGenSpectator').onclick = async ()=>{
  if(!current.battleId) return alert('전투를 먼저 생성하세요.');
  const res = await fetch(`/api/admin/battles/${current.battleId}/links`,{method:'POST'}).then(r=>r.json());
  if(res?.ok){
    $('spectatorOtp').value = res.spectatorOtp||'';
    renderPlayerLinks(res.playerLinks||[]);
  }
};
$('btnBuildSpectator').onclick = ()=>{
  const otp=$('spectatorOtp').value.trim();
  if(!current.battleId || !otp) return;
  const u = new URL(location.href);
  u.pathname = '/spectator'; u.search = `?battle=${encodeURIComponent(current.battleId)}&otp=${encodeURIComponent(otp)}`;
  $('spectatorUrl').value = u.toString();
  navigator.clipboard?.writeText(u.toString()).catch(()=>{});
};

$('btnSend').onclick = sendChat;
$('chatMsg').addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); sendChat(); }});
function sendChat(){
  const msg = $('chatMsg').value.trim(); if(!msg || !current.battleId) return;
  socket.emit('chatMessage',{battleId:current.battleId, name:'관리자', message:msg});
  $('chatMsg').value='';
}

/* ===== sockets in ===== */
socket.on('battleUpdate', onUpdate);
socket.on('battle:update', onUpdate);
function onUpdate(b){
  if(!current.battleId) setBattleId(b.id);
  renderTeams(b);
}

socket.on('battleLog', addLog);
socket.on('battle:log', addLog);

socket.on('chatMessage', addChat);
socket.on('battle:chat', addChat);

socket.on('battle:started', ()=>addLog({type:'system',message:'전투 시작'}));
socket.on('battleStarted', ()=>addLog({type:'system',message:'전투 시작'}));
socket.on('battle:ended', d=> addLog({type:'system',message:`전투 종료 (승자: ${d?.winnerLabel||d?.winner||''})`}));

/* player link render */
function renderPlayerLinks(links){
  const wrap=$('playerLinks'); wrap.innerHTML='';
  links.forEach((url,i)=>{
    const row=document.createElement('div');
    row.innerHTML = `<div class="kv">
      <span class="key">링크 ${i+1}</span>
      <input type="url" value="${url}" readonly style="flex:1"/>
      <button class="btn" data-url="${url}">복사</button>
    </div>`;
    wrap.appendChild(row);
    row.querySelector('button').onclick=()=> navigator.clipboard?.writeText(url);
  });
}

/* 초기 상태 */
setConn(socket.connected);
</script>
</body>
</html>
